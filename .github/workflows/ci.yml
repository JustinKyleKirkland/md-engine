name: MD Engine CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ============================================
  # Tier 1: Unit Tests (<10s)
  # ============================================
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/test_box.py tests/test_state.py tests/test_topology.py \
                 tests/test_forcefields.py tests/test_integrators.py \
                 tests/test_neighborlist.py \
                 -v --tb=short

  # ============================================
  # Tier 2: Smoke Tests (<30s)
  # ============================================
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: unit
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run smoke tests
        run: pytest tests/test_smoke.py -v --tb=short

  # ============================================
  # Tier 3: Physics Benchmarks (<1min)
  # ============================================
  physics:
    name: Physics Benchmarks
    runs-on: ubuntu-latest
    needs: smoke
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Phase A (Physics)
        run: pytest tests/benchmarks/test_phase_a_physics.py -v --tb=short

      - name: Run Phase B (MD)
        run: pytest tests/benchmarks/test_phase_b_md.py -v --tb=short

  # ============================================
  # Tier 4: Gate Tests (Hard Requirements)
  # ============================================
  gates:
    name: Gate Tests
    runs-on: ubuntu-latest
    needs: physics
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate reference data
        run: python -m tests.reference.generate_reference

      - name: Run numerical gates
        run: pytest tests/gates/test_numerical_gates.py -v --tb=short

      - name: Run determinism gates
        run: pytest tests/gates/test_determinism_gates.py -v --tb=short

      - name: Run ML gates
        run: pytest tests/gates/test_ml_gates.py -v --tb=short

  # ============================================
  # Tier 5: Parallel Tests (<2min)
  # ============================================
  parallel:
    name: Parallel Tests
    runs-on: ubuntu-latest
    needs: gates
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install MPI
        run: sudo apt-get install -y mpich

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mpi4py

      - name: Run Phase C (Parallel)
        run: pytest tests/benchmarks/test_phase_c_parallel.py -v --tb=short

  # ============================================
  # Tier 6: ML Tests (<2min)
  # ============================================
  ml:
    name: ML Tests
    runs-on: ubuntu-latest
    needs: gates
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Phase D (ML)
        run: pytest tests/benchmarks/test_phase_d_ml.py -v --tb=short

      - name: Run ML validation
        run: pytest tests/validation/test_ml_benchmarks.py -v --tb=short

  # ============================================
  # Tier 7: Performance Regression (<3min)
  # ============================================
  performance:
    name: Performance Regression
    runs-on: ubuntu-latest
    needs: [parallel, ml]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run performance gates
        run: pytest tests/gates/test_performance_gates.py -v --tb=short

  # ============================================
  # Full Validation Suite
  # ============================================
  full-validation:
    name: Full Validation
    runs-on: ubuntu-latest
    needs: performance
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run all validation tests
        run: pytest tests/validation/ -v --tb=short

      - name: Run all tests with coverage
        run: pytest tests/ --cov=mdcore --cov-report=xml -v

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
